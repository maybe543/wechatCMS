<!DOCTYPE html>
<html lang='zh-CN'>
<head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <meta content='width=device-width, user-scalable=no' name='viewport'>
    <meta charset='utf-8'>
    <meta content='IE=Edge,chrome=1' http-equiv='X-UA-Compatible'>
    <script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"74f55de04c","applicationID":"6749604","transactionName":"IlcLQxBeWFoHShYAWAxIBF4FX0cZAVZATE4ISw0=","queueTime":0,"applicationTime":13,"agentToken":null,"agent":"js-agent.newrelic.com/nr-593.min.js"}</script>
    <script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(n,e,t){function r(t){if(!e[t]){var o=e[t]={exports:{}};n[t][0].call(o.exports,function(e){var o=n[t][1][e];return r(o?o:e)},o,o.exports)}return e[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({QJf3ax:[function(n,e){function t(n){function e(e,t,a){n&&n(e,t,a),a||(a={});for(var u=c(e),f=u.length,s=i(a,o,r),p=0;f>p;p++)u[p].apply(s,t);return s}function a(n,e){f[n]=c(n).concat(e)}function c(n){return f[n]||[]}function u(){return t(e)}var f={};return{on:a,emit:e,create:u,listeners:c,_events:f}}function r(){return{}}var o="nr@context",i=n("gos");e.exports=t()},{gos:"7eSDFh"}],ee:[function(n,e){e.exports=n("QJf3ax")},{}],3:[function(n,e){function t(n){return function(){r(n,[(new Date).getTime()].concat(i(arguments)))}}var r=n("handle"),o=n(1),i=n(2);"undefined"==typeof window.newrelic&&(newrelic=window.NREUM);var a=["setPageViewName","addPageAction","setCustomAttribute","finished","addToTrace","inlineHit","noticeError"];o(a,function(n,e){window.NREUM[e]=t("api-"+e)}),e.exports=window.NREUM},{1:12,2:13,handle:"D5DuLP"}],gos:[function(n,e){e.exports=n("7eSDFh")},{}],"7eSDFh":[function(n,e){function t(n,e,t){if(r.call(n,e))return n[e];var o=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(n,e,{value:o,writable:!0,enumerable:!1}),o}catch(i){}return n[e]=o,o}var r=Object.prototype.hasOwnProperty;e.exports=t},{}],D5DuLP:[function(n,e){function t(n,e,t){return r.listeners(n).length?r.emit(n,e,t):(o[n]||(o[n]=[]),void o[n].push(e))}var r=n("ee").create(),o={};e.exports=t,t.ee=r,r.q=o},{ee:"QJf3ax"}],handle:[function(n,e){e.exports=n("D5DuLP")},{}],XL7HBI:[function(n,e){function t(n){var e=typeof n;return!n||"object"!==e&&"function"!==e?-1:n===window?0:i(n,o,function(){return r++})}var r=1,o="nr@id",i=n("gos");e.exports=t},{gos:"7eSDFh"}],id:[function(n,e){e.exports=n("XL7HBI")},{}],loader:[function(n,e){e.exports=n("G9z0Bl")},{}],G9z0Bl:[function(n,e){function t(){var n=h.info=NREUM.info;if(n&&n.licenseKey&&n.applicationID&&f&&f.body){c(l,function(e,t){e in n||(n[e]=t)}),h.proto="https"===d.split(":")[0]||n.sslForHttp?"https://":"http://",a("mark",["onload",i()]);var e=f.createElement("script");e.src=h.proto+n.agent,f.body.appendChild(e)}}function r(){"complete"===f.readyState&&o()}function o(){a("mark",["domContent",i()])}function i(){return(new Date).getTime()}var a=n("handle"),c=n(1),u=(n(2),window),f=u.document,s="addEventListener",p="attachEvent",d=(""+location).split("?")[0],l={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-593.min.js"},h=e.exports={offset:i(),origin:d,features:{}};f[s]?(f[s]("DOMContentLoaded",o,!1),u[s]("load",t,!1)):(f[p]("onreadystatechange",r),u[p]("onload",t)),a("mark",["firstbyte",i()])},{1:12,2:3,handle:"D5DuLP"}],12:[function(n,e){function t(n,e){var t=[],o="",i=0;for(o in n)r.call(n,o)&&(t[i]=e(o,n[o]),i+=1);return t}var r=Object.prototype.hasOwnProperty;e.exports=t},{}],13:[function(n,e){function t(n,e,t){e||(e=0),"undefined"==typeof t&&(t=n?n.length:0);for(var r=-1,o=t-e||0,i=Array(0>o?0:o);++r<o;)i[r]=n[e+r];return i}e.exports=t},{}]},{},["G9z0Bl"]);</script>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' name='viewport'>
    <title></title>
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.1/html5shiv.js"></script>
    <![endif]-->
    <script type="text/javascript">
        //<![CDATA[
        window.gon={};gon.template=0;
        //]]>
    </script>

    <link href="{YYZF_RES}css/application-188f527191be3bb3b10e2b76058e8d30.css" media="all" rel="stylesheet" />
    <script src="{YYZF_RES}js/application-4e489d46a0f13506104d24a2ec3cfd1f.js"></script>
    <script data-apikey="bff3ce1f67b978b57ba2301c472b359f" src="http://d2wy8f7a9ursnm.cloudfront.net/bugsnag-2.min.js"></script>
    <meta content="authenticity_token" name="csrf-param" />
    <meta content="PwyJ3kolN/rHT5eThV1sN2T6ivuP9Fh9Ox8t2rSUliY=" name="csrf-token" />
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "http://hm.baidu.com/hm.js?d8538168bc46b513593e767269f8a6f0";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

</head>
<body class='cny-wish'>
<div class='navbar navbar-default navbar-static-top hidden'>
    <div class='container'>
        <button class='navbar-toggle' data-target='.navbar-responsive-collapse' data-toggle='collapse' type='button'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
        </button>
        <a class='navbar-brand' href='/'></a>
        <div class='navbar-collapse collapse navbar-responsive-collapse'>
            <ul class='nav navbar-nav navbar-right'>
                <li><a href="/users/sign_out">codeMonkey09</a></li>
            </ul>
        </div>
    </div>
</div>
<div class='container no-gutters'>
    <div class='row no-gutters'>
        <div class='col-lg-12'>

        </div>
    </div>
</div>
<div class='container no-gutters'>
    <div class='row no-gutters'>

        <div class='wish-container'>
            <div id='title'></div>
            <a class="btn-init" href="#" id="btn-record"></a>
            <div id='guide'></div>
            <div id='timer'></div>
            <div class='guide-text'>
              {$yy['record_tip']}
            </div>
            <a class="retake" href="#"></a>
        </div>
        <div class='bottom-bar'>
            <!--<a class="btn-back clearfix" href="/campaigns/cny"></a>-->
            <a href="#" id="btn-done"></a>
        </div>
        <style>
            body {
                background-image: url("{YYZF_RES}images/bg-tile.png");
            }
            div.wish-container {
                text-align: center;
            }
            #title {
                display: block;
                height: 29px;
                margin: 50px auto 20px auto;
            }
            .title-record {
                width: 269px;
                /*background-image: url('{YYZF_RES}images/title1.png');*/
                font-size: 16pt;
                color: #ffffff;
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            .title-play {
                width: 269px;
               /* background-image: url('{YYZF_RES}images/title2.png');*/
                font-size: 16pt;
                color: #ffffff;
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            #btn-record {
                display: block;
                width: 208px;
                height: 208px;
                margin: 40px auto;
            }
            .btn-init {
                background-image: url('{YYZF_RES}images/microphone.png');
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            .btn-recording {
                background-image: url('{YYZF_RES}images/stop.png');
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            .btn-recorded {
                background-image: url('{YYZF_RES}images/play.png');
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            .btn-playing {
                background-image: url('{YYZF_RES}images/pause.png');
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            #timer {
                display: block;
                margin: 0 auto 20px auto;
                color: white;
                font-size: 35px;
                font-family: Georgia, Cambria, "Times New Roman", Times, serif;
            }
            #guide {
                display: block;
                margin: 20px auto;
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            .guide-init {
                width: 208px;
                height: 29px;
                background-image: url('{YYZF_RES}images/record-text.png');
            }
            .guide-recording {
                width: 208px;
                height: 29px;
                background-image: url('{YYZF_RES}images/record-text.png');
            }
            .guide-recorded {
                width: 118px;
                height: 29px;
                background-image: url('{YYZF_RES}images/play-text.png');
            }
            .guide-playing {
                width: 118px;
                height: 29px;
                background-image: url('{YYZF_RES}images/play-text.png');
            }
            div.guide-text {
                color: #F4B9B1;
            }
            .retake {
                display: block;
                margin: 20px auto;
                width: 58.5px;
                height: 28.5px;
                background-image: url('{YYZF_RES}images/retake.png');
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            div.bottom-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 49px;
                background-color: #AF4544;
                opacity: 80;
                text-align: center;
            }
            .btn-back {
                display: inline-block;
                float: left;
                width: 62px;
                height: 21px;
                margin: 14px 10px 0 14px;
                background-image: url('{YYZF_RES}images/back.png');
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
            #btn-done {
                display: block;
                margin: 7px auto;
                width: 140px;
                height: 35px;
                background-image: url('{YYZF_RES}images/done.png');
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }
        </style>
        {php echo register_jssdk(false);} <!-- 放到其他引入的 js 之前 -->
        <script>
            (function() {
                $(document).ready(function() {
                    var autoLayout, c, localConfig;
                    window.state = 'init';
                    window.recordId = '';
                    window.mediaId = '';
                    autoLayout = function(state) {
                        window.state = state;
                        if (state === 'init') {
                            $('#title').removeClass().addClass('title-record');
                            $('#title').html("{$yy['start_title']}!");
                            $('#btn-record').removeClass().addClass('btn-init');
                            $('#guide').removeClass().addClass('guide-init');
                            $('#guide').show();
                            $('.guide-text').show();
                            $('.retake').hide();
                            $('#btn-done').hide();
                            return $('#timer').hide();
                        } else if (state === 'recording') {
                            startTimer();
                            $('#title').removeClass().addClass('title-record');
                            $('#btn-record').removeClass().addClass('btn-recording');
                            $('#guide').removeClass().addClass('guide-recording');
                            $('#guide').hide();
                            $('.guide-text').show();
                            $('.retake').hide();
                            $('#btn-done').hide();
                            return $('#timer').show();
                        } else if (state === 'recorded') {
                            stopTimer();
                            $('#title').removeClass().addClass('title-play');
                            $('#btn-record').removeClass().addClass('btn-recorded');
                            $('#guide').removeClass().addClass('guide-recorded');
                            $('#guide').show();
                            $('.guide-text').hide();
                            $('.retake').show();
                            $('#btn-done').show();
                            return $('#timer').hide();
                        } else if (state === 'playing') {
                            $('#title').removeClass().addClass('title-play');

                            $('#btn-record').removeClass().addClass('btn-playing');
                            $('#title').html("{$yy['play_title']}");

                            $('#guide').removeClass().addClass('guide-playing');
                            $('#guide').show();
                            $('.guide-text').hide();
                            $('.retake').show();
                            $('#btn-done').show();
                            return $('#timer').hide();
                        }
                    };
                    autoLayout(window.state);
                    window.seconds = 0;
                    window.timer = void 0;
                    window.startTimer = function() {
                        return window.timer = setInterval(function() {
                            window.seconds += 1;
                            window.seconds = Math.min(window.seconds, 59);
                            console.log(window.seconds);
                            if (window.seconds < 10) {
                                return $('#timer').html("0:0" + window.seconds);
                            } else {
                                return $('#timer').html("0:" + window.seconds);
                            }
                        }, 1000);
                    };
                    window.stopTimer = function() {
                        if (window.timer !== void 0) {
                            clearInterval(window.timer);
                            window.seconds = 0;
                            return $('#timer').html("0:0" + window.seconds);
                        }
                    };

                    return wx.ready(function() {
                        console.log('wx jssdk set ready');


                        sharedata = {
                            title: "{$yy[share_title]}",
                            desc: "{$yy[share_content]}",
                            link: window.location.href,
                            imgUrl: "{$_W['attachurl']}{$yy['share_icon']}",
                            success: function(){

                            },
                            cancel: function(){

                            }
                        };
                        wx.onMenuShareAppMessage(sharedata);
						wx.onMenuShareTimeline(sharedata);



                        $('#btn-record').on('click', function(event) {
                            event.preventDefault();
                            console.log(window.state);
                            if (window.state === 'playing') {
                                autoLayout('recorded');
                                return wx.stopVoice({
                                    localId: window.recordId
                                });
                            } else if (window.state === 'recorded') {
                                autoLayout('playing');
                                wx.playVoice({
                                    localId: window.recordId
                                });
                                return wx.onVoicePlayEnd({
                                    success: function(res) {
                                        return autoLayout('recorded');
                                    }
                                });
                            } else if (window.state === 'recording') {
                                return wx.stopRecord({
                                    success: function(res) {
                                        autoLayout('recorded');
                                        return window.recordId = res.localId;
                                    }
                                });
                            } else if (window.state === 'init') {
                                autoLayout('recording');
                                wx.startRecord();

                                return wx.onVoiceRecordEnd({
                                    complete: function(res) {
                                        autoLayout('recorded');
                                        return window.recordId = res.localId;
                                    }
                                });
                            }
                        });


                        $('#btn-done').on('click', function(event) {
                            return wx.uploadVoice({
                                localId: window.recordId,
                                isShowProgressTips: 1,
                                success: function(res) {
                                    window.mediaId = res.serverId;







                                    //window.location="{php echo $this->createMobileUrl('play',array(),true)}&mid="+ window.mediaId;

                                    return $.ajax({
                                        url: "{php echo $this->createMobileUrl('ZFRecord',array(),true)}",
                                        type: "POST",
                                        dataType: "json",
                                        data: {
                                            "yid": "{$yy['id']}",
                                            "serverId": window.mediaId
                                        },
                                        success: function(res) {
                                            if(res.code==200){
                                                 window.location.href=res['url'];

                                            }else if(res.code==501){
                                                window.location.href='{$yy['follow_url']}'
                                            }else{

                                                alert(res.msg);
                                            }

                                        }
                                    });


                                }
                            });


                        });
                        return $('.retake').on('click', function(event) {
                            window.recordId = '';
                            window.mediaId = '';
                            return autoLayout('init');
                        });
                    });
                });

            }).call(this);
        </script>

    </div>
</div>
</body>
</html>
